<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wei.pet.pet_rescue.mapper.PetConsultationMapper">
    <select id="selectConsultationSummary" resultType="com.wei.pet.pet_rescue.entity.vo.ConsultationSummaryVO">
        SELECT
            c.ask_user_id,
            u.nickname AS askUserNickname,
            u.avatar AS askUserAvatar,
            MAX(c.create_time) AS lastTime,
            COUNT(c.id) AS msgCount,
            (SELECT question FROM pet_consultation WHERE pet_id = #{petId} AND ask_user_id = c.ask_user_id ORDER BY create_time DESC LIMIT 1) as lastMessage
        FROM pet_consultation c
                 LEFT JOIN sys_user u ON c.ask_user_id = u.id
        WHERE c.pet_id = #{petId} AND c.is_deleted = 0
        GROUP BY c.ask_user_id, u.nickname, u.avatar
        ORDER BY lastTime DESC
    </select>
</mapper>
